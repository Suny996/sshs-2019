<!DOCTYPE html>
<head>
	<meta charset="UTF-8">
    <title>贷款逾期情况</title>
</head>
<style>
		body {
		    width:100%;
			font: 30px arial;
			font-size: 14px;
			background-color: #fff;
		}
		div.tooltip {
			position: absolute;
			min-width: 50px;
			min-height: 50px;
			padding: 10px 16px;
			border: 0px;
			border-radius: 8px;
			pointer-events: none;
			font-family: "SimSun";
			/*font-size: 20px;*/
			text-align: left;
			color: black;
			opacity: 0.9;
			background: #17168A;
			box-shadow: 0 23px 24px 0 rgba(0, 0, 0, 0.50);
			border-radius: 10px;
			text-transform: uppercase;
			font-weight: 60;
		}
		
		div.tooltip span {
			text-transform: none;
			font-weight: normal;
			font-size: 14px;
		}
		
		div.tooltip span:last-child {
			font-weight: 300;
		}
		
		svg text {
			/*font-size: 10px;  
		   font-family: "Open Sans";
		   
		   font-weight: 600;
		   */
			
		}
		
		rect {
			stroke-width: 2;
			cursor: pointer;
		}
		
		rect.disabled {
			fill: transparent !important;
		}
		
		path.slice {
			stroke-width: 2px;
		}
		
		polyline {
			opacity: .3;
			/*stroke: gray;*/
			stroke-width: 1.5px;
			fill: none;
		}
		

		.title { /*font-family:Arial,微软雅黑;font-size:18px;*/
			text-anchor: middle;
			background-color: rgb(10, 24, 92);
			  border-top-left-radius: 5px;
			  border-top-right-radius: 5px;
		}
		
		.height-auto {
			font-size: 12px;
			margin-top: 10px;
			border: none;
			text-align: right;
		}
		
		
	/* 	.height-auto {
			font-family: 微软雅黑;
			font-size: 12px;
			height: auto;
			border: none;
			margin-top: 10px;
		} */
		
		.left{
            width:46%;
            height:400px;
            margin-left:2.7%;
            background:#fff;
            float:left;
            margin-bottom:30px;
               /*  border: 1px solid red; */
        }
        .right{
        	
            height:420px;
            margin-left:200px;
            background:#fff;
        }
        #content{
			height:100%;
			width:100%;
			margin:0 auto;
			text-align:center;
			background-color: #fff;
			padding-top:30px;
		}
        #prirosepie,#cusprosepie{
        	margin:0px 0px 0px 0px;
			box-shadow: 2px 2px 10px #888888;
        }
        
        #cusrosepie,#priprosepie{
        	margin:0px 0px 0px 0px;
			box-shadow: 2px 2px 10px #888888;
        }
        .title{
			font-size: 14px;
			color:white;
			background-color:rgb(10, 24, 92);
			width:100%;
/* 			margin-left:22px;
 */			margin-right:10px;
			padding:10px 0px;
			text-align: left;
			text-indent: 1em;
		}
		.title2{
			font-size: 14px;
			color:white;
			
			width:95%;
			/* margin-left:10px; */
			margin-right:30px;
			padding:10px 0px;
			text-align: left;
			text-indent: 1em;
			float:right;
			background-color: rgb(10, 24, 92);
			  border-top-left-radius: 5px;
			  border-top-right-radius: 5px;
		}
		
		
		#list_box{
		width:100%;
		float:left;
			color:white;
			margin:0 auto;
			text-align:center;
			padding-bottom:30px;
		}
		#list{
			background-color: #fff;
			margin-left:30px;
			margin-right:30px;
			box-shadow: 2px 2px 10px #888888;
		}
		.tb_title,#tb_title{
			color:#7a7b89;
		}
		.tb_title{
			width:150px;
		}
		.tt{
			color:#666;
		}
		#tb_title{
			height:45px;
		}
		
		#tab{
			text-align:center;
		}
		table tr td{
			border:1px solid #424562;
			width:100px;
			height:30px;
			color:#666
		}
		
</style>
<body>
		
	<div id="content">
            <div class="left">
            	<div class="title">余额</div>
            	<div id="prirosepie"></div>
            </div>
            <div class="left">
            	<div class="title">存量客户数</div>
                <div id="cusrosepie"></div>
            </div>
            <div class="left">
            	<div class="title">存量客户数占比</div>
            	<div id="cusprosepie"></div>
            </div>
            <div class="left">
            	<div class="title">余额占比</div>
            	<div id="priprosepie"></div>
            </div>
      
        <div id="list_box">
    	<div class="title2">贷款逾期情况 Retail Loan Distribution By Delinquency</div>
    	<div id="list">
    		<table id="tab" align="center">
    			<tr id="tb_title">
    				<td class="tb_title" rowspan=2>逾期情况 <br>Delinquency</td>
    			    <td colspan=4 ><span style='mso-spacerun:yes'>&nbsp; </span>时间 Date: 2018年4月30日</td>				
    			</tr>
    				<td class="tb_title" >存量客户数 <br>Customers</td>
    				<td class="tb_title" >占比<br>Customer Percentage</td>
    				<td class="tb_title" >余额<br>Principal </td>
    				<td class="tb_title" >占比<br>Principal Percentage </td> 
    			<tr>
    			</tr>
    			<tr id="tb_title">
    				<td class="tb_title">无逾期 M0 </td>
    				<td class="tt">500 </td>
    				<td class="tt">50.00%</td>
    				<td class="tt">2100 </td>
    				<td class="tt">35.00% </td> 				
    			</tr>
    			<tr id="tb_title">
    				<td class="tb_title">逾期一期 M1 </td>
    				<td class="tt">198 </td>
    				<td class="tt">19.80%</td>
    				<td class="tt">1200 </td>
    				<td class="tt">20.00% </td> 				
    			</tr>
    			<tr id="tb_title">
    				<td class="tb_title">逾期二期 M2 </td>
    				<td class="tt">102 </td>
    				<td class="tt">10.02%</td>
    				<td class="tt">1109 </td>
    				<td class="tt">18.49%</td> 				
    			</tr>
    			<tr id="tb_title">
    				<td class="tb_title">逾期三期 M3 </td>
    				<td class="tt">86 </td>
    				<td class="tt">8.60%</td>
    				<td class="tt">1091 </td>
    				<td class="tt">18.18% </td> 				
    			</tr>
    			<tr id="tb_title">
    				<td class="tb_title">逾期四期 M4</td>
    				<td class="tt">114</td>
    				<td class="tt">11.40%</td>
    				<td class="tt">500 </td>
    				<td class="tt">8.33%</td> 				
    			</tr>
    			<tr id="tb_title">
    				<td class="tb_title">总计 </td>
    				<td class="tt">1000 </td>
    				<td class="tt">100.00%</td>
    				<td class="tt">6000 </td>
    				<td class="tt">100.00% </td> 				
    			</tr>
        </div>
   </div>
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/font-awesome.min.css">
<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/img-common.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
<script type="text/javascript" >
	var data1=[
		 {x0: "无逾期", y0: "2100"},
		 {x0: "逾一期", y0: "1200"},
		 {x0: "逾二期", y0: "1109"},
		 {x0: "逾三期", y0: "1091"},
		 {x0: "逾四期", y0: "500"}
	 ]
	var data2=[
		{x0: "无逾期", y0: "500"},
		{x0: "逾一期", y0: "198"},
		{x0: "逾二期", y0: "102"},
		{x0: "逾三期", y0: "86"},
		{x0: "逾四期", y0: "114"}
	]
	var data3=[
		{x0: "无逾期", y0: "50.00%"},
		{x0: "逾一期", y0: "19.80%"},
		{x0: "逾二期", y0: "10.20%"},
		{x0: "逾三期", y0: "8.60%"},
		{x0: "逾四期", y0: "11.40%"}
	]
	var data4=[
		{x0: "无逾期", y0: "35.00%"},
		{x0: "逾一期", y0: "20.00%"},
		{x0: "逾二期", y0: "18.49%"},
		{x0: "逾三期", y0: "18.18%"},
		{x0: "逾四期", y0: "8.33%"}
	]
	
	var roseattr={
		backGround: null,
		baseId: "bb81b2b44cf041c0bda64a75d5296ddd",
		height: 350,
		id: 5,
		innerRadius: 0,
		labelsDisplay: 1,
		labelsFont: "微软雅黑",
		labelsFontColor: "#666",
		labelsFontSize: 10,
		labelsLocation: "enter",
		legendFont: "微软雅黑",
		legendFontColor: "#666",
		legendFontSize: 6,
		legendSymbol: null,
		outerRadius: 110,
		padHeight: 200,
		padLeft: 300,
		rosePieName: "roseCustp",
		title: null,
		titleColor: "#24cdba",
		titleFont: "微软雅黑",
		titleFontSize: 15,
		titleLocation: "center",
		toolTipFont: "MicrosoftYaHei",
		toolTipFontColor: "#542bc1",
		toolTipFontSize: 14,
		toolTipOpacity: 9,
		width: 620,
	}
	
	var label1=["#prirosepie","#cusrosepie","#cusprosepie","#priprosepie"]
	
	rosepie(data1,roseattr,label1[0]);
	rosepie(data2,roseattr,label1[1]);
	rosepie(data3,roseattr,label1[2]);
	rosepie(data4,roseattr,label1[3]);
	function rosepie(data,rose,label){
			var rosePie=rose,jsdata=data;
 			
 			d3.select(label).select("svg").remove();
			
		    var datax=[];// 提取x轴数据
		    var datay=[];// 提取y轴数据
		    var dataz=[];
			toData();
			var data111=targetToObject(datax,datay,dataz)
			
		var svg = d3.select(label)
					.append("svg")
					.append("g");
			
				svg.append("g")
					.attr("class", "slices");
				svg.append("g")
					.attr("class", "labelName");
				svg.append("g")
					.attr("class", "labelValue");
				svg.append("g")
					.attr("class", "lines");
				 
	    var width = rosePie.width,//500,		//画布宽	
			height = rosePie.height,//400,        //画布高
			radius = rosePie.outerRadius,//300 * 0.4,//外半径
			minRadius = rosePie.innerRadius,//500 *0.00;//内半径
			
	        title="存量客户数占比";
		d3.select(label).select("svg")
		     .style('width','100%')
//			.attr("width", width-100)
			.attr("height", height)
			//.style("background-color","#13163b");
		//添加标题中间标题(-15,-198)
		/*if(title!=""){
		   svg.append("g")
			.append("text")
			.text(title)
			.attr("class","title")
			.attr("x",-15)//左边距离15
			.attr("y",-200)//上方距离200
			.style('fill','white')
			.style("font-size",rosePie.titleFontSize)
			.style("font-family",rosePie.titleFont);//Arial,微软雅黑
			
		}*/
	
		var defs = d3.select("svg").append("defs");

		var filter = defs.append("filter")
				.attr("id", "drop-shadow")
				.attr("height", "200%")
				.attr("width", "200%")
				.attr("y", "-50%")
				.attr("x", "-50%");

		filter.append("feGaussianBlur")
				.attr("in", "SourceAlpha")
				.attr("stdDeviation", 8000)//区域阴影效果
				.attr("result", "blur");

		filter.append("feOffset")//区域阴影效果
			.attr("in", "blur")
			.attr("dx", 1000)
			.attr("dy", 100)
			.attr("result", "offsetBlur");

		var feMerge = filter.append("feMerge");

		feMerge.append("feMergeNode").attr("in", "offsetBlur");
		feMerge.append("feMergeNode").attr("in", "SourceGraphic");		
		svg.attr("transform", "translate(" + width / 3 + "," + height / 2 + ")");//图形位置
		//颜色变化
		var color = d3.scaleOrdinal().range(["#cf2c39", "#cd7631" , "#2b821d", "#3d62c6", "#03549a" ]);
		
		var data = data111[0];//data1
		var colordata=[];
			for(var i=0;i<data.length;i++){ colordata.push(data[i].type)}
		var arc = d3.arc()
			.innerRadius(minRadius/3)
			.outerRadius(height / 2);
        //鼠标移入后的半径
		var outerArc = d3.arc()
	        .innerRadius(radius * 1.1)
	        .outerRadius(radius * 1.1);
	  
		var pie = d3.pie().sort(null).value(function(d) {
			return d.value;
		});

		
		//初始提示框透明度
		var div = d3.select("body")
				.append("div")
				.attr("class", "tooltip")
				.style("opacity", .0);
      
	    //最大值
		var maxValue = data.reduce(function(current, max) {
			return max.value > current ? max.value : current;
		}, 0);
		//总数值
		var totalePartecipanti = data.reduce(function(current, acc) {
			return acc = acc.value + current;
		}, 0);

		console.log(maxValue);
		//提示框	
		var slice=svg.select('.slices');
		var path=slice.selectAll(".arc")
			.data(pie(data))
			.enter()
			.append("path")
			.attr("class", "arc")
			.attr("id",function(d,i){ return d.data.type;})
			.attr("d", function(d, i) {return arc.outerRadius((radius - minRadius) / maxValue * d.data.value + minRadius)(d, i);})
		   // .attr("style", function(d, i) {return " stroke: " + color(i) + ";";})
			.attr("fill",function(d,i){	return color(d.data.type);})//color(i)
			.each(function(d) { this._current = d;})
			.style("filter", "url(#drop-shadow)");
		
			path.on("mouseover", function(d, i) {
			      
					div.transition()
						.duration(200)//过渡时间
						.style("opacity", (rosePie.toolTipOpacity));//提示框背景透明度color(i)"."+
					div.html(d.data.type + "<br/><span style='color:#fff;'>" + d.data.label +"</span> <span></span>")//每个区域的名字，颜色，数据值
						.style("left", d3.event.pageX+20 + "px")
						.style("top", d3.event.pageY - 28 + "px")
						.style("color",rosePie.toolTipFontColor)//提示框字体颜色
						.style("font-family",rosePie.toolTipFont)//提示框字体
						.style("font-size",rosePie.toolTipFontSize+"px")//提示框字体大小
						.style("opacity",1.0)
						.style("font-size","14px")// piep.toolTipFontSize
						.style("background","#63676c")// piep.toolTipbgcolor
						.style("color","#fff")
						.style('font-weight','normal')
						.style('font-stretch','normal')
						.style('letter-spacing','0px')
						.style('border-radius','5px')
						.style('text-align','center')
						.style("font-famliy","MicrosoftYaHei");
					     //过度效果半径变大
						//console.log(d3.easeLinear);
						d3.select(this).transition()//选择节点设置
							.duration(200)
							.ease(d3.easeElastic)
							.attr("d",function(d, i) {
									return arc.outerRadius((radius - minRadius) / maxValue * d.data.value + minRadius+10)(d, i);
							});
					
					
					//颜色加深	
					var currPath=d3.select(this);
					var mm=d3.select(this.parentNode.parentNode).select(".lines").select("#"+d.data.type+"");
					var tt=d3.select(this.parentNode.parentNode).select(".labelName").select("#"+d.data.type+"");
					mm.style("opacity",.9);
					tt.style("opacity",.9);
					var darkenedColor=d3.rgb(color(d.data.type)).brighter(0.3);
					//console.log(darkenedColor);
						currPath.attr('fill',darkenedColor);
						
					
				})
			.on("mouseout", function(d,i) {
				div.transition()
					.duration(500)
					.style("opacity", 0.0);
				
				d3.select(this).transition()
						.duration(200)
						.ease(d3.easeElastic)
						.attr("d",function(d, i) {
									return arc.outerRadius((radius - minRadius) / maxValue * d.data.value + minRadius)(d, i);
							});
				var currPath=d3.select(this);
				//设置标签线是否显示
				var mm=d3.select(this.parentNode.parentNode).select(".lines").select("#"+d.data.type+"");
				var tt=d3.select(this.parentNode.parentNode).select(".labelName").select("#"+d.data.type+"");
				mm.style("opacity",.9);
				tt.style("opacity",.9);
					var darkenedColor=d3.rgb(color(d.data.type)).brighter(0);
						currPath.attr("fill",function(d){
							return darkenedColor ;
						});
			});	
		
	draw(data);
	function draw(data){	
		var bool=true;
		//标签文本	
	     var text = svg.select(".labelName").selectAll("text")
			.data(pie(data), function(d) {
				return d.data.type
			});
		
		function midAngle(d) {
			
			return d.startAngle + (d.endAngle - d.startAngle) / 2;
		}
		//标签是否显示
		function opa(bool){
			if(bool==true) 
				return 0.9; 
			else 
				return 0.9;
		}
		text.enter()
			.append("text")
			.attr("dy", ".35em")
			.style("opacity",opa)
			.attr("id",function(d,i){ return d.data.type;})
			.text(function(d) {
				return (d.data.value + " patients | " + d.data.value * 100.0 / totalePartecipanti + "%");
			}).transition().duration(1000)
			.attrTween("transform", function(d) {
						this._current = this._current || d;
						var interpolate = d3.interpolate(this._current, d);
						this._current = interpolate(0);
						return function(t) {
							var d2 = interpolate(t);
							var pos = outerArc.centroid(d2);
							pos[0] = radius * (midAngle(d2) < Math.PI ? 1.1 : -1.1);
							return "translate(" + pos + ")";
						};
			})
			.styleTween("text-anchor", function(d) {
									this._current = this._current || d;
									var interpolate = d3.interpolate(this._current, d);
									this._current = interpolate(0);
									return function(t) {
										var d2 = interpolate(t);
										return midAngle(d2) < Math.PI ? "start" : "end";};
			})
			.text(function(d) {return (d.data.label);})//(d.data.type +"  " + Math.round(d.data.value * 100.0 / totalePartecipanti) + "%")
			.style("font-size",rosePie.labelsFontSize+"px")//rosePie.labelsFontSize
			.style("fill",rosePie.labelsFontColor);//rosePie.labelsFontColor
		
		text.exit()
			.remove();
		//线
		var polyline = svg.select(".lines").selectAll("polyline")
			.data(pie(data), function(d) {
				return d.data.type;
			});
	   
		polyline.enter()
			.append("polyline")
			.attr("id",function(d,i){ return d.data.type;})
		    .style("opacity",opa)
			.transition().duration(1000)
			.attr('stroke',function(d,i){
				return color(d.data.type);
			})
			.attrTween("points", function(d) {
				this._current = this._current || d;
				var interpolate = d3.interpolate(this._current, d);
				this._current = interpolate(0);
				return function(t) {
					/*	var d2 = interpolate(t);
						var pos = outerArc.centroid(d2);
						pos[0] = radius * 0.95 * (midAngle(d2) < Math.PI ? 1 : -1);
						return [arc.centroid(d2), outerArc.centroid(d2), pos];*/
						
						var d2 = interpolate(t);
						var oArc = d3.arc()
								.innerRadius(1 * ((radius - minRadius) / maxValue * d.data.value))
								.outerRadius(1 * ((radius - minRadius) / maxValue * d.data.value));
						
						var pos = outerArc.centroid(d2);
					     	pos[0] = radius * (midAngle(d2)<Math.PI ? 1 : -1);
						return [oArc.centroid(d2), outerArc.centroid(d2), pos];
				};
	        })
	        .style("font-family","微软雅黑")//rosePie.labelFont
	        .style("font-size","5px");//rosePie.labelFontSize

		polyline.exit()
			.remove();
		
	}	
	
		
		//图例位置
		var legend = svg.selectAll('.legend')
	     	.data(colordata)
	     	.enter()
	     	.append('g')
	     	.attr('class', 'legend')
	     	.attr('transform', function(d, i) {
	    	 	var height = 23;//legendRectSize + legendSpacing;
	    	 	var offset = height * color.domain().length / 2;  //竖值图例
	    	 		//console.log(color.domain());
	    	 	var horz = 10 * 15+25;//180
	    	 	var vert = i * height - offset;
	    	 	return 'translate(' + horz+ ',' + vert + ')';
	     });
		 
		
	    //图例图形
	    legend.append('rect')
	     .attr('width', 23)
	     .attr('height', 15)
	     .attr('rx',3)
	     .attr('ry',3)
	     .style('fill', color)
	     .style('stroke', color)
	     .on('mouseover',function(d){
						var currPath=d3.select(this);
					    var darkenedColor=d3.rgb(color(d)).brighter(0.4);// brighter()
					        currPath.style('fill',darkenedColor);
					    var path1=d3.select(this.parentNode.parentNode).select('.slices').select('#'+d);
					    //console.log(path1)
					        path1.transition()// 选择节点设置
		                         .duration(300)
		                         .ease(d3.easeElastic)
		                         .attr('d', function(d,i){
		                        	 return arc.outerRadius((radius - minRadius) / maxValue * d.data.value + minRadius+10)(d, i);
		                         })
		 })
		.on('mouseout',function(d){
					var currPath=d3.select(this);
					var darkenedColor=d3.rgb(color(d)).brighter(0);// brighter()
						     currPath.style('fill',darkenedColor); 
					var path1=d3.select(this.parentNode.parentNode).select('.slices').select('#'+d);
						     path1.transition()// 选择节点设置
			                      .duration(300)
			                      .ease(d3.easeElastic)
			                      .attr('d', function(d,i){
			                    	  return arc.outerRadius((radius - minRadius) / maxValue * d.data.value + minRadius)(d, i);
			                      })
					 })
	     .on('click', function(type) {
			  var data1;
			  var no=d3.select(this.parentNode.parentNode);
			  console.log(no);
			  var pl=d3.select(this.parentNode.parentNode).select(".lines").select("#"+type+"");
			  var lt=d3.select(this.parentNode.parentNode).select(".labelName").select("#"+type+""); 
			  var p=d3.select("body").selectAll("path");
			  //console.log(mm);
              var rect = d3.select(this);//当前dom元素
              var enabled = true;
              var totalEnabled = d3.sum(data.map(function(d) {  
                return (d.enabled) ? 1 : 0;
              }));
              
              if (rect.attr('class') === 'disabled') {
                rect.attr("class", "");
              } else {
                if (totalEnabled < 2) return;
                rect.attr('class', 'disabled');
                enabled = false;
              }
             
			//重新排序
              pie.sort(null).value(function(d) {				  
                if (d.type === type) d.enabled = enabled;
                return (d.enabled) ? d.value : 0;
              });
			
			//标签显示  
              if(enabled==false){  
            	  pl.style("opacity",0);
            	  lt.style("opacity",0);
              }else{
            	  pl.style("opacity",.9);
            	  lt.style("opacity",.9);
              };
			//数据重新整理
              var temp=[];
              for(var i=0;i<data.length;i++){
            	  if(data[i].type==type) {
            		  temp[i]=data[i].value;
            		  if(rect.attr('class'=='disabled')){
            			  data[i].value=0;
            		  }else{
            			  data[i].value=temp[i];
						//console.log(temp);
            		  }
            		  data1=data;
					//console.log(data1);
				}
						
              }
			update();
			
			  function update(){
					function midAngle(d) {
						return d.startAngle + (d.endAngle - d.startAngle) / 2;
					}
					
					var path=no.select(".slices").selectAll("path").data(pie(data1));//d3--no
						path.transition()
							.duration(500)
							.ease(d3.easeExp)
							.attrTween('d', function(d) {
								
								var interpolate = d3.interpolate(this._current, d);
								this._current = interpolate(0);
								return function(t) {
									
									var oArc = d3.arc()
									      .innerRadius(0)
									      .outerRadius(1 * ((radius - minRadius) / maxValue * d.data.value));							
									//console.log(maxValue);
									return oArc(interpolate(t));
								};
							});	
						 // .attr("d", function(d, i) { 
							 // return arc.outerRadius(1 * ((radius - minRadius) / maxValue * d.data.value))(d, i);})
					path.exit().remove();
					
					var text = no.select(".labelName").selectAll("text")//svg--no
									.data(pie(data1));
						
						text.enter()
							.append("text")
						    .attr("dy", ".35em");
						text.transition().duration(500)
							.attrTween("transform", function(d) {
									this._current = this._current || d;
									var interpolate = d3.interpolate(this._current, d);
									this._current = interpolate(0);
									return function(t) {
										var d2 = interpolate(t);
										var pos = outerArc.centroid(d2);
										pos[0] = radius * (midAngle(d2) < Math.PI ? 1.1 : -1.1);
										return "translate(" + pos + ")";
									};
							})
							.styleTween("text-anchor", function(d) {
									this._current = this._current || d;
									var interpolate = d3.interpolate(this._current, d);
									this._current = interpolate(0);
									return function(t) {
										var d2 = interpolate(t);
										return midAngle(d2) < Math.PI ? "start" : "end";
									};
							})
							.text(function(d) {
								return (d.data.label );//+"  " + Math.round(d.data.value * 100.0 / totalePartecipanti) + "%"
							});
						text.exit().remove();
					var polyline = no.select(".lines").selectAll("polyline")//d3--no
									.data(pie(data1));

						polyline.enter()
								.append("polyline")

						polyline.transition()
								.duration(500)
								.attrTween("points", function(d) {
									console.log(111)
									this._current = this._current || d;
									var interpolate = d3.interpolate(this._current, d);
									this._current = interpolate(0);
									return function(t) {
										/*var d2 = interpolate(t);
										var pos =  outerArc.centroid(d2);
									    pos[0] = radius * .95 * (midAngle(d2) < Math.PI ? 1 : -1);
										return [arc.centroid(d2), outerArc.centroid(d2),pos];*/
										var d2 = interpolate(t);
										var oArc = d3.arc()
												.innerRadius(1 * ((radius - minRadius) / maxValue * d.data.value))
												.outerRadius(1 * ((radius - minRadius) / maxValue * d.data.value));
									
										var pos = outerArc.centroid(d2);
									     	pos[0] = radius * (midAngle(d2)<Math.PI ? 1 : -1);
										return [oArc.centroid(d2), outerArc.centroid(d2), pos];
									};
								});
						polyline.exit()
								.remove();
					
			  }
        });
		 
			//图例标签
			  svg.selectAll('.legend')
				 .data(pie(data))
				 .append('text')
			     .attr('x', 25)//图例字体与图例水平距离
			     .attr('y', 13)//图例字体竖直距离
			     .text(function(d) {return d.data.type;})
			     .style("font-family",rosePie.legendFont)//rosePie.legendFont
				 .style("fill",rosePie.legendFontColor)
			     .style("font-size",rosePie.legendFontsize+"px");//rosePie.legendFontsize
			
		
			 svg.append("text")
				.text(totalePartecipanti)//总和
				.attr("text-anchor", "middle")
				.attr("dy", "0.50rem")
				.attr("fill", "white")
				.attr('opacity',.0);
		
	
				function toData(){	
					
					var n=0;
					
					for(var a=0;a<jsdata.length;a++){//数组长度
							var data1="";
							for(var i=0;i<Object.keys(jsdata[0]).length;i++){//对象长度
										var xb=Object.keys(jsdata[a]).some(key => key.includes('x'+i));
										var yb=Object.keys(jsdata[a]).some(key => key.includes('y'+i));
										
										if(xb==true & Object.keys(jsdata[0]).length != 2){
											data1+=jsdata[a]['x'+i]+"_";
											//console.log(data1);
										}if(xb==true & Object.keys(jsdata[0]).length == 2){
											data1+=jsdata[a]['x'+i];
										}if(xb==false & i!=1 & i!=0){
											if(i%2==0 & i!=2){
					                           n=i-1; 
											}else{
											   n=i;
											}	
										}if(xb==false & i==1 ||xb==false & i==0){
											n=1;
										}			
							};
							if(Object.keys(jsdata[0]).length != 2){
								data1 = data1.substring(0, data1.lastIndexOf('_'));
								datax.push(data1);
							}else{
								datax.push(data1);
							}
					};
					//console.log(datax);
					//console.log(n);
					for(var i=0;i<Object.keys(jsdata[0]).length-n;i++){
						  datay[i]=[]; 
						  //dataz[i]=[];
					}
					for(var a=0;a<jsdata.length;a++){//数组长度
							var data2;
							for(var i=0;i<Object.keys(jsdata[0]).length;i++){//对象长度
									var xb=Object.keys(jsdata[a]).some(key => key.includes('x'+i));
									var yb=Object.keys(jsdata[a]).some(key => key.includes('y'+i));
									if(yb==true){
										  var dsd;
										  data2=jsdata[a]['y'+i];
										  dataz.push(data2);
										  if((typeof data2)=='string' & data2.indexOf("%") != -1){
											    d3d=Number(data2.substring(0,data2.lastIndexOf('%')));
											    	//d3d=Number(d3d.toString().match(/^\d+(?:\.\d{0,2})?/));
											    	//d3d=d3d.toFixed(2);
											    	//console.log(d3d);
										  }else{
											    	d3d=Number(data2);
											    	//console.log(typeof d3d);
										}
												//console.log(data2);
												datay[i].push(d3d);		
										};				
							};
					};
				}
				//console.log(dataz)
				//后台数据转为数组对象:[{},{},...]
				function targetToObject(datax,datay,dataz){
					var dataset=[];//封装数据				
					for(var i=0;i<datay.length;i++){
						dataset[i]=[];
					}
					for(var i=0;i<datax.length;i++){
					     for(var j=0;j<datay.length;j++){
							var obj={
								angle:1,
								type:datax[i],
								value:datay[j][i],
								label:dataz[i],
								enabled:true
							}
							dataset[j].push(obj);
						}

					}
					//console.log(dataset);
					
					return dataset;
				}
	}
</script>
</body>
</html>