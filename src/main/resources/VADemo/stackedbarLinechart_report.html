<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>评分区间及通过率</title> 
</head>
<style>
body {

	/*width: 1020px;*/
	 width:100%;
	height: 1000px;
	background: #fff;
	color: #fff;
}


.tb_title, #tb_title {
	color: #7a7b89;
}

.tb_title {
	width: 150px;
}

#tb_title {
	height: 45px;
}

#tab {
	margin:auto;
	text-align: center;
	
}

td {
	border: 1px solid #424562;
	width: 175px;
	height: 30px;
	color:#666
}

/* .axis path, .axis line {
	fill: none;
	stroke: #6A6C7D;
	shape-rendering: crispEdges;
}

.axis text {
	fill: #666;
	font-family: sans-serif;
	font-size: 11px;
} */

#speedometer {
	margin-top:40px;
	margin-left:20px;
	width: 440px;
	background-color: #fff;
	
}

#line {
	margin-top:20px;
	margin-left:20px;
	width: 440px;
	background-color: #fff;
	
}

.first {
	float: left;
	margin-left: 30px;
	margin-top: 30px;
	/*width: 460px;*/
	 width:46%;
	height: 484px;
	background-color: #fff;
	box-shadow: 2px 2px 10px #888888;
}

.second {
	float: left;
	margin-left: 30px;
	margin-top: 30px;
	/*width: 460px;*/
	 width:45%;
	height: 485px;
	background-color: #fff;
	box-shadow: 2px 2px 10px #888888;
}

#list {
	
	/*width: 945px;*/
	width:94%;
	height:400px;
	background-color: #fff;
	margin-top: 30px;
	margin-left: 30px;
	float:left;
	box-shadow: 2px 2px 10px #888888;
}
p{
	 border-top-left-radius: 5px;
   border-top-right-radius: 5px;
}
</style>

<body>
	<!--堆积图div -->
	<div class="first">
	     <p style="height:30px;padding:10px 0; text-indent:1.5em;background:rgb(10, 24, 92);line-height: 1">评分区间及客户数</p>
		<div id="speedometer"></div>
	</div>

	<div class="second">
	<p style="height:30px;padding:10px 0; text-indent:1.5em;background:rgb(10, 24, 92);line-height: 1;">评分区间及通过率</p>
		<div id="line"></div>
	</div>

	<div id="list">
		<div>
			<p style="height:30px;padding:10px 0;background:rgb(10, 24, 92); line-height: 1; text-indent: 1.5em; color: #fff;">评分区间及通过率</p>
		</div>
		<table id="tab" >
			<tr id="tb_title">
				<td class="tb_title">评分<br>Score interval
				</td>
				<td class="tb_title">客户数<br>Customers
				</td>
				<td class="tb_title">通过客户数<br>Accepts
				</td>	
				<td class="tb_title">被拒客户数<br>Rejects
				</td>
				<td class="tb_title">通过率<br>Approve rate
				</td>
			</tr>
			<tr>
				<td>172-226</td>
				<td>300</td>
				<td>84</td>
				<td>216</td>
				<td>28.00%</td>
			</tr>
			<tr>
				<td>227-241</td>
				<td>700</td>
				<td>300</td>
				<td>400</td>
				<td>42.86%</td>
			</tr>
			<tr>
				<td>242-253</td>
				<td>1000</td>
				<td>700</td>
				<td>300</td>
				<td>70.00%</td>
			</tr>
			<tr>
				<td>254-269</td>
				<td>1200</td>
				<td>1120</td>
				<td>80</td>
				<td>93.33%</td>
			</tr>
			<tr>
				<td>270-370</td>
				<td>700</td>
				<td>691</td>
				<td>9</td>
				<td>98.71%</td>
			</tr>
			<tr>
				<td>合计<br>Total
				</td>
				<td>3900</td>
				<td>2895</td>
				<td>1005</td>
				<td>74.23%</td>
			</tr>
		</table>
	</div>
	<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/font-awesome.min.css">
<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/img-common.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
<script type="text/javascript" >
	line();
	stackbar();
	function line(){
	
			var data=[
						{"date":"172-226","通过率":"0.28"},
						{"date":"227-241","通过率":"0.4286"},
						{"date":"242-253","通过率":"0.7"},
						{"date":"254-269","通过率":"0.9333"},
						{"date":"270-370","通过率":"0.9871"}
					]
			var moreLineChart={
							background: "#fff",
							baseId: "ac8a091a52f44e8ebc24ee94afbc7040",
							createTime: "2018-10-11 16:29:59",
							createUser: "管理员",
							drawTime: 1,
							height: 400,
							id: 52,
							ifCurvbasis: 1,
							lineNameFont: "sans-serif",
							lineNameSize: 10,
							lineNameStation: 3,
							lineWidth: 2,
							moreLineChartName: "评分区间及通过率",
							padBottom: 20,
							padLeft: 40,
							padRight: 20,
							padTop: 20,
							updateTime: "2018-10-13 10:58:19",
							width: 400,
							xFontSize: 11,
							xGridColor: "#424562",
							xGridLucid: 0.5,
							xLableColor: "#666",
							xLableSize: 14,
							xLineColor: "#666",
							xNameColor: "#666",
							xScaleColor: "#666",
							xStation1: "-10",
							xStation2: "400",
							xText: "评分区间",
							yFontSize: 11,
							yGridColor: "#424562",
							yGridLucid: 0.5,
							yLableColor: "#666",
							yLableSize: 14,
							yLineColor: "#666",
							yNameColor: "#666",
							yScaleColor: "#666",
							yStation1: 0,
							yStation2: -15,
							yText: "通过率"
				}
			var parseTime = d3.timeParse("%Y%m%d");
			var padding=40
			var head_height=padding;
			var foot_height=padding;
//
//			for(var i=0;i<data.length;i++){
//			
//				 data[i].date = new Date(data[i].date);
////				data[i].date=parseTime(data[i].date);
//			}

			var colum=[];
			Object.keys(data[1]).forEach(function(key,i,v){
				  colum.push(key)
			})  
			data.columns=colum;				
				d3.select('#line').select("svg").remove();
				var svg1 = d3.select("#line")
							 .append("svg")
							 .attr("width", moreLineChart.width)
						     .attr("height",moreLineChart.height)
							 .attr("transform", "translate(" + (moreLineChart.padLeft+10) + "," + 0 + ")")
						     .style("background-color",moreLineChart.background);

				var svg = d3.select('#line').select("svg"), margin = {
					left : moreLineChart.padLeft,
					right : moreLineChart.padRight,
					top : moreLineChart.padTop,
					bottom : moreLineChart.padBottom
				}, width = +svg.attr("width") - margin.left - margin.right, height = +svg
						.attr("height")- margin.top - margin.bottom, g = svg.append("g")
						.attr("transform","translate(" + margin.left + ","+ margin.top + ")");


				var x = d3.scaleBand().rangeRound([0, width]),
				    y = d3.scaleLinear().range([height, 0]),
				    z = d3.scaleOrdinal(d3.schemeCategory10);
				
               var od =moreLineChart.ifCurvbasis;//是否为圆滑曲线
               var line;
               if(od==1){
            	    line = d3.line()
				    .curve(d3.curveBasis)
				    .x(function(d) { return x(d.date); })
				    .y(function(d) { return y(d.temperature); });
               }
               else{
            	    line = d3.line()
//				    .curve(curveBasis)
				    .x(function(d) { return x(d.date); })
				    .y(function(d) { return y(d.temperature); });
               }
				

				  var cities = data.columns.slice(1).map(function(id) {
				    return {
				      id: id,
				      values: data.map(function(d) {
				        return {date: d.date, temperature: d[id]};
				      })
				    };
				  });
					console.log(data);

				  x.domain(data.map(function (d) {
				        return d.date;
				    }));
				  y.domain([
				    d3.min(cities, function(c) { return d3.min(c.values, function(d) { return d.temperature; }); }),
				    d3.max(cities, function(c) { return d3.max(c.values, function(d) { return d.temperature; }); })
				  ]);

				  z.domain(cities.map(function(c) { return c.id; }));
				  
				  
			  g.append("g")
			      .attr("class", "axis axis--x")
			      .attr("transform", "translate(0," + height + ")")
			      .style("stroke",moreLineChart.xLableColor)//X轴标签颜色
			       .style("font-size",moreLineChart.xLableSize)//X轴标签大小
			      .call(d3.axisBottom(x))
			    .append("text")
			      .attr("transform", "rotate(0)")
			      .attr("y",moreLineChart.xStation1)//X轴标签的上下位置(-10)
			      .attr("dx", moreLineChart.xStation2)//X轴标签的左右位置
			      .style("fill", moreLineChart.xNameColor)
			      .style("font-size",moreLineChart.xFontSize+"px")//X轴名称大小
			      .style("stroke",moreLineChart.xNameColor)
			      .text(moreLineChart.xText); //X轴名称
			      

			  g.append("g")
			      .attr("class", "axis axis--y")
			     .style("stroke",moreLineChart.yLableColor)//Y轴标签颜色
			      .style("font-size",moreLineChart.yLableSize+"px")//y轴标签大小
			      .call(d3.axisLeft(y))
			    .append("text")
			      .attr("transform", "rotate(" + moreLineChart.yStation1 + ")")
			      .attr("y", moreLineChart.yStation2)//Y轴标签的左右位置
			      .attr("dy", "0.71em")
			      .style("fill", moreLineChart.yNameColor)
			      .style("font-size",moreLineChart.yFontSize+"px")//y轴名称大小
			      .style("stroke",moreLineChart.yNameColor)
			      .text(moreLineChart.yText);
			  
			  d3.select('.axis--y path')
			    .style("stroke",moreLineChart.yLineColor)//Y轴线的颜色
			    .style("shape-rendering",'crispEdges');
			  
			  d3.selectAll('.axis--y line')
			    .style("stroke",moreLineChart.yScaleColor)//Y轴刻度的颜色
			    .style("shape-rendering",'crispEdges');
			  
			  d3.select('.axis--x path')
			    .style("stroke",moreLineChart.xLineColor)//X轴线的颜色
			    .style("shape-rendering",'crispEdges');
			  
			  d3.selectAll('.axis--x line')
			    .style("stroke",moreLineChart.xScaleColor)//X轴刻度的颜色
			    .style("shape-rendering",'crispEdges');
			  
			  d3.selectAll("g.axis--y g.tick")
			    .append("line")
			    .classed("grid-line", true)
			    .attr("x1", 0)
			    .attr("y1", 0)
			    .attr("x2", moreLineChart.width-moreLineChart.padRight-moreLineChart.padLeft)
			    .attr("y2", 0)
			    //.style("stroke",moreLineChart.xGridColor)
			    .style("stroke-opacity",moreLineChart.xGridLucid);
			
			  d3.selectAll("g.axis--x g.tick")
			    .append("line")
			    .classed("grid-line", true)
			    .attr("x1", 0)
			    .attr("y1", 0)
			    .attr("x2", 0)
			    .attr("y2", -moreLineChart.height+moreLineChart.padTop+moreLineChart.padBottom)
			    //.style("stroke",moreLineChart.yGridColor)
			    .style("stroke-opacity",moreLineChart.yGridLucid);

			  var city = g.selectAll(".city")
			    .data(cities)
			    .enter().append("g")
			      .attr("class", "city");
			  
			  city.append("path")
			      .attr("class", "line")
			      .attr("d", function(d,i) { return line(d.values); })
			      .style("fill",'none')
			      .style("stroke", function(d) { return  z(d.id); })
			      .style("stroke-width",moreLineChart.lineWidth)
			      .style("stroke-opacity",0.9);

			  city.append("text")
			      .datum(function(d) { return {id: d.id, value: d.values[d.values.length - 1]}; })
			      .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.temperature) + ")"; })
			      .attr("x",moreLineChart.lineNameStation)
			      .attr("dy", "0.35em")
			      .style("font-size", moreLineChart.lineNameSize+"px")//折线名称的字体大小
			      .style("font-family", moreLineChart.lineNameFont)//折线名称字体样式
			      .style("fill",function(d) { return  z(d.id); })
			      .text(function(d) { return d.id; });
			  
			//在不知道折线的具体长度的时候可以动态添加动画属性。
	         	 var path = document.getElementsByClassName('line'); 
	         	 var length =[];
	         	 for(var h=0;h<path.length;h++){
	         	 length.push( path[h].getTotalLength());	
	         	 }//获取class标签为line的元素
	         				//获取第一个折线的总共的长度
	         	 d3.selectAll('.line')
	         	 .style('stroke-dasharray', function(d,i){
	         		 return length[i]
	         	 })					//根据上面获取的值来设置stroke-dasharray值
	         	 .style('stroke-dashoffset', function(d,i){
	         		 return length[i]
	         	 });
	 
	         	 var rule = "@keyframes dash {0%{stroke-dashoffset:" + length + ";}100%{ stroke-dashoffset: 0;}  }";
	         	 var style = document.createElement('style');
	         	 style.type = 'text/css';
	         	 style.innerHTML = rule;
	         	document.getElementsByTagName('head')[0].appendChild(style);
	         	for(var i=0;i<path.length;i++){
		         	 path[i].style.animation = "dash "+moreLineChart.drawTime+"s linear forwards";//加载动画时间

	         	}
		

			function type(d, _, columns) {
			  d.date = parseTime(d.date);
			  console.log( d.date)
			  for (var i = 1, n = columns.length, c; i < n; ++i) d[c = columns[i]] = +d[c];
			  return d;
			};
	}
	
	function stackbar(){
		var data =[ 	
							{x0: "172-226", 客户数: 84, 拒绝客户数: 216},
							{x0: "227-241", 客户数: 300, 拒绝客户数: 400},
							{x0: "242-253", 客户数: 700, 拒绝客户数: 300},
							{x0: "254-269", 客户数: 1120, 拒绝客户数: 80},
							{x0: "270-370", 客户数: 691, 拒绝客户数: 9}
					];
		var stackedbar={axisColor: "#666",
					axisLabelColor: "#666",
					axisLabelFontFamily: "sans-serif",
					axisLabelFontSize: 14,
					axisRotate: 0,
					axisTickColor: "#666",
					background: "#fff",
					baseId: "4e9b9ee9c6714ab181a1d4a08f438c5d",
					createTime: "2018-10-11 15:59:29",
					createUser: "管理员",
					fontColor: "#000",
					fontFamily: "微软雅黑",
					fontSize: 14,
					fontWeight: "noraml",
					height: 400,
					hoverfill: "red",
					hoverfillOpacity: 0.8,
					id: 28,
					legendDx: null,
					legendDy: null,
					legendFontColor: "#666",
					legendFontSize: 12,
					legendSize: 12,
					marBottom: 10,
					marLeft: 10,
					marRight: 10,
					marTop: 10,
					padBottom: 40,
					padLeft: 40,
					padRight: 40,
					padTop: 30,
					rectPadding: 0.5,
					rectWidth: 0.1,
					rectfill: "#3080ff,#4ccb72,#0cf1d9",
					rectfillOpacity: 0.8,
					stackedbarName: "评分区间及客户数",
					stroke: "#20252b",
					strokeOpacity: 0.8,
					titleDx: 0,
					titleDy: 0,
					updateTime: "2018-10-11 18:51:03",
					width: 393,
					x: 0,
					xOrient: "bottom",
					xTextAnchor: "middle",
					xTickpadding: 5,
					xTicks: 5,
					xTicksize: 5,
					xTitle: null,
					xTitleDx: 8,
					xTitleDy: 0,
					y: 0,
					yOrient: "left",
					yTextAnchor: "middle",
					yTickpadding: 5,
					yTicks: 5,
					yTicksize: 5,
					yTitle: null,
					yTitleDx: 2,
					yTitleDy: 0}
		var margin = {top: stackedbar.padTop, right: stackedbar.padRight, bottom: stackedbar.padBottom, left: stackedbar.padLeft},
				width =stackedbar.width ,
				height = stackedbar.height ;
				d3.select("#speedometer").select("svg").remove();
			var svg = d3.select("#speedometer").append("svg")
					.attr("width",width)
					.attr("height",height)
					.style("background-color",stackedbar.background)
					.attr("transform", "translate(" + (margin.left+5) + "," + 0 + ")");
					//.style("border","1px solid"+ stackedbar.stroke);
			width=svg.attr("width")-margin.left-margin.right;
			height=svg.attr("height")-margin.top-margin.bottom;
			
			var g = svg.append("g").attr("transform", "translate(" + (margin.left+5) + "," + margin.top + ")");

		var x=d3.scaleBand()
			.rangeRound([0,width])
			.padding(stackedbar.rectWidth)
			.paddingInner(stackedbar.rectPadding)
			.align(0.5);//柱体与y轴距离
			
		var y = d3.scaleLinear()
			.rangeRound([height, 0]);
		
		var color=[];
		color=stackedbar.rectfill;
		var color_ary=color.split(",");
		
		var z = d3.scaleOrdinal()
		.range(color_ary);
		
		//数据处理
		var data_sbar=[];
		data_sbar=data;
		var colum=[];
		Object.keys(data_sbar[0]).forEach(function(key,i,v){
			  colum.push(key)
		})  
		data_sbar.columns=colum;

		for( var h=0;h<data_sbar.length;h++){
			var d=data_sbar[h];
			d.total=0;
			var columns=data_sbar.columns;
			for (var i = 1, t = 0; i < columns.length; i++)
			t += d[columns[i]] = +d[columns[i]];
			d.total = t;
		}

		
		var keys = data_sbar.columns.slice(1);
		//排序
		/*data_sbar.sort(function(a, b) { return b.total - a.total; });
		console.log(data_sbar)*/
		x.domain(data_sbar.map(function(d) { return d.x0; }));
		y.domain([0, d3.max(data_sbar, function(d) { return d.total; })]).nice();
		z.domain(keys);

		g.append("g")
		.selectAll("g")
		.data(d3.stack().keys(keys)(data_sbar))
		.enter().append("g")
		  .attr("fill", function(d) { return z(d.key); })
		.selectAll("rect")
		.data(function(d) { return d; })
		.enter().append("rect")
		  .attr("x", function(d) { return x(d.data.x0); })
		  .attr("y", function(d) { return y(d[1]); })
		  .attr("height", 0)
		  .attr("width", x.bandwidth())
		  .attr("fill-opacity",stackedbar.rectfillOpacity)
		  .transition().duration(500)
		  .attr("height", function(d) { return y(d[0]) - y(d[1]); });
		
		//提示框
		var tooltip=d3.select("body")
			.append("div")
			.attr("class","tooltip")
			.style("opacity",0.0);
			
		var rect=d3.selectAll("rect");
		  rect.on("mouseover",function (d,i) {
			  var tt=Object.keys(d.data);
				tooltip.html(function(){
					 var  html='';

					for(var h=0;h<+tt.length;h++){
						html+=tt[h]+':'+d.data[tt[h]]+'<br/>';
					
					}
					return html;
				})
				.style("left",(d3.event.pageX)+"px")
				.style("top",(d3.event.pageY)+"px")
				.style("opacity",1.0)
				.style("font-size","14px")// piep.toolTipFontSize
				.style("background","#63676c")// piep.toolTipbgcolor
				.style("color","#fff")
				.style('font-weight','normal')
				.style('font-stretch','normal')
				.style('letter-spacing','0px')
				.style('border-radius','5px')
				.style('text-align','left')
				.style("font-famliy","MicrosoftYaHei");// piep.tooltipFont;
			})
			.on("mousemove",function(d){
				tooltip.style("left",(d3.event.pageX)+"px")
					   .style("top",(d3.event.pageY+20)+"px");
			})
			.on("mouseout",function(d){
				tooltip.style("opacity",0.0);
				
			});

		g.append("g")
		  .attr("class", "axis-x")
		  .attr("transform", "translate(0," + height + ")")
		  .call(d3.axisBottom(x).ticks(stackedbar.xTicks).tickSize(stackedbar.xTicksize))
		  .append("text")
		  .attr("x",width-margin.left-margin.right)
		  .attr("y",2)
		  .attr("dy", stackedbar.xTitleDy+"em")
		  .attr("dx", stackedbar.xTitleDx+"em")
		  .attr("fill", "#000")
		  .attr("font-weight", "bold")
		  .attr("text-anchor", stackedbar.xTextAnchor)
		  .text(stackedbar.xTitle);

		g.append("g")
		  .attr("class", "axis-y")
		  .call(d3.axisLeft(y).ticks(stackedbar.yTicks).tickSize(stackedbar.yTicksize))
		.append("text")
		  .attr("x", 2)
		  .attr("y", y(y.ticks().pop()) + 0.5)
		  .attr("dx", stackedbar.yTitleDx+"em")
		  .attr("dy", stackedbar.yTitleDy+"em")
		  .attr("fill", "#000")
		  .attr("font-weight", "bold")
		  .attr("text-anchor", stackedbar.yTextAnchor)
		  .style("font-size",stackedbar.fontSize+"px")
		  .text(stackedbar.yTitle);

		var legend = g.append("g")
		  .attr("font-family", "sans-serif")
		  .attr("font-size", 10)
		  .attr("text-anchor", "end")
		.selectAll("g")
		.data(keys.slice().reverse())
		.enter().append("g")
		  .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  		
  		
		//图例方框
		legend.append("rect")
		  .attr("x", width+stackedbar.legendDx+5)
		  .attr("y",stackedbar.legendDy-stackedbar.legendSize+2)
		  .attr("width", stackedbar.legendSize)
		  .attr("height", stackedbar.legendSize)
		  .attr("fill", z)
		  .attr("fill-opacity",stackedbar.rectfillOpacity);

		//图例文字
		legend.append("text")
		  .attr("x", width+stackedbar.legendDx)
		  .attr("y", stackedbar.legendDy)
		  .text(function(d) { return d; })
		  .attr("fill",stackedbar.legendFontColor)
		  .style("font-size",stackedbar.legendFontSize);
		
		
		//样式转换
		d3.selectAll(".axis-x path").style("stroke",stackedbar.axisColor);
		d3.selectAll(".axis-y path").style("stroke",stackedbar.axisColor);
		d3.selectAll(".axis-x line").style("stroke",stackedbar.axisTickColor);
		d3.selectAll(".axis-y line").style("stroke",stackedbar.axisTickColor);
  		d3.selectAll(".axis-x text").style("fill",stackedbar.axisLabelColor)
  			.style("font-size",stackedbar.axisLabelFontSize)
  			.style("font-family",stackedbar.axisLabelFontFamily)
  			.attr("transform","rotate("+stackedbar.axisRotate+")")
  		d3.selectAll(".axis-y text").style("fill",stackedbar.axisLabelColor)
  			.style("font-size",stackedbar.axisLabelFontSize)
  			.style("font-family",stackedbar.axisLabelFontFamily);
  		
  		if(stackedbar.axisRotate!=null && stackedbar.axisRotate>0){
  			d3.selectAll(".axis-x text").style("text-anchor","start");
  		}else if(stackedbar.axisRotate!=null && stackedbar.axisRotate<0){
  			d3.selectAll(".axis-x text").style("text-anchor","end")
  		}else{
  			d3.selectAll(".axis-x text").style("text-anchor","middle")
  		}

		//删除数据中total属性
		for(var h=0;h<data_sbar.length;h++){
		delete data_sbar[0].total;
		}
		
	}
</script>
</body>
</html>