<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>
零售信用贷款新增情况
</title> 
</head>
<style>
#content {
	height: 100%;
	width: 100%;
	margin: 0 auto;
	text-align: center;
	background-color: #fff;
	padding-top: 30px;
}

#speedometer, #speedometer2, #speedometer3 {
	background-color: #fff;
	margin: 0px 30px 30px 30px;
	box-shadow: 2px 2px 10px #888888;
}

.title {
	font-size: 14px;
	color: white;
	background-color: rgb(10, 24, 92);
	  border-top-left-radius: 5px;
	  border-top-right-radius: 5px;
	margin-left: 30px;
	margin-right: 30px;
	padding: 10px 0px;
	text-align: left;
	text-indent: 1em;
}

#list_box {
	color: white;
	margin: 0 auto;
	text-align: center;
	padding-bottom: 30px;
}

#list {
	background-color: #fff;
	margin-left: 30px;
	margin-right: 30px;
	box-shadow: 2px 2px 10px #888888;
}

.tb_title, #tb_title {
	color: #7a7b89;
}

.tb_title {
	width: 150px;
}

#tb_title {
	height: 45px;
}

#tab {
	text-align: center;
}

table tr td {
	border: 1px solid #424562;
	width: 100px;
	height: 30px;
	color:#666
}

/* 坐标轴样式 */
.axis path, .axis line {
	fill: none;
	stroke: #666;
	shape-rendering: crispEdges;
}

.axis text {
	fill: #666;
	font-family: sans-serif;
	font-size: 11px;
}
</style>


<body>
	<div id="content">
		<div class="chart_box">
			<div class="title">新增客户</div>
			<div id="speedometer"></div>
		</div>
		<div class="chart_box">
			<div class="title">新增余额</div>
			<div id="speedometer2"></div>
		</div>
		<div class="chart_box">
			<div class="title">新增额度</div>
			<div id="speedometer3"></div>
		</div>

		<div id="list_box">
			<div class="title">零售信用贷款新增情况</div>
			<div id="list">
				<table id="tab">
					<tr id="tb_title">
						<td class="tb_title"></td>
						<td class="tb_title">收入状况 <br>Wealth Level
						</td>
						<td>2017-05</td>
						<td>2017-06</td>
						<td>2017-07</td>
						<td>2017-08</td>
						<td>2017-09</td>
						<td>2017-10</td>
						<td>2017-11</td>
						<td>2017-12</td>
						<td>2018-01</td>
						<td>2018-02</td>
						<td>2018-03</td>
						<td>2018-04</td>
					</tr>
					<tr>
						<td rowspan="3" class="tb_title">新增客户<br>New Customer
						</td>
						<td class="tb_title">普通Mass</td>
						<td>1000</td>
						<td>900</td>
						<td>1000</td>
						<td>700</td>
						<td>800</td>
						<td>900</td>
						<td>800</td>
						<td>900</td>
						<td>1100</td>
						<td>700</td>
						<td>1000</td>
						<td>900</td>
					</tr>
					<tr>
						<td class="tb_title">中等Middle</td>
						<td>600</td>
						<td>500</td>
						<td>600</td>
						<td>300</td>
						<td>400</td>
						<td>500</td>
						<td>400</td>
						<td>500</td>
						<td>700</td>
						<td>300</td>
						<td>600</td>
						<td>500</td>
					</tr>
					<tr>
						<td class="tb_title">富裕Affluent</td>
						<td>300</td>
						<td>200</td>
						<td>300</td>
						<td>150</td>
						<td>100</td>
						<td>200</td>
						<td>100</td>
						<td>200</td>
						<td>400</td>
						<td>200</td>
						<td>300</td>
						<td>200</td>
					</tr>
					<tr>
						<td rowspan="3" class="tb_title">新增余额<br>New principal
							utilized by new customer
						</td>
						<td class="tb_title">普通Mass</td>
						<td>700</td>
						<td>900</td>
						<td>800</td>
						<td>900</td>
						<td>700</td>
						<td>600</td>
						<td>900</td>
						<td>1100</td>
						<td>600</td>
						<td>700</td>
						<td>900</td>
						<td>800</td>
					</tr>
					<tr>
						<td class="tb_title">中等Middle</td>
						<td>400</td>
						<td>600</td>
						<td>500</td>
						<td>600</td>
						<td>400</td>
						<td>300</td>
						<td>600</td>
						<td>800</td>
						<td>300</td>
						<td>400</td>
						<td>600</td>
						<td>500</td>
					</tr>
					<tr>
						<td class="tb_title">富裕Affluent</td>
						<td>200</td>
						<td>400</td>
						<td>300</td>
						<td>400</td>
						<td>200</td>
						<td>100</td>
						<td>400</td>
						<td>600</td>
						<td>100</td>
						<td>200</td>
						<td>400</td>
						<td>300</td>
					</tr>
					<tr>
						<td rowspan="3" class="tb_title">新增额度<br>New limit setup
							to new customer
						</td>
						<td class="tb_title">普通Mass</td>
						<td>700</td>
						<td>600</td>
						<td>700</td>
						<td>400</td>
						<td>500</td>
						<td>600</td>
						<td>500</td>
						<td>600</td>
						<td>800</td>
						<td>400</td>
						<td>700</td>
						<td>600</td>
					</tr>
					<tr>
						<td class="tb_title">中等Middle</td>
						<td>250</td>
						<td>150</td>
						<td>250</td>
						<td>50</td>
						<td>50</td>
						<td>150</td>
						<td>50</td>
						<td>150</td>
						<td>350</td>
						<td>50</td>
						<td>250</td>
						<td>150</td>
					</tr>
					<tr>
						<td class="tb_title">富裕Affluent</td>
						<td>100</td>
						<td>100</td>
						<td>100</td>
						<td>200</td>
						<td>100</td>
						<td>80</td>
						<td>90</td>
						<td>50</td>
						<td>200</td>
						<td>200</td>
						<td>100</td>
						<td>100</td>
					</tr>
				</table>
			</div>
		</div>
	</div>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/font-awesome.min.css">
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="css/img-common.css">
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" >
	var data1=[
				{x0: "2017-05", 普通MASS: 1000, 中等MIDDLE: 600, 富裕AFFLUENT: 300},
				{x0: "2017-06", 普通MASS: 900, 中等MIDDLE: 500, 富裕AFFLUENT: 200},
				{x0: "2017-07", 普通MASS: 1000, 中等MIDDLE: 600, 富裕AFFLUENT: 300},
				{x0: "2017-08", 普通MASS: 700, 中等MIDDLE: 300, 富裕AFFLUENT: 150},
				{x0: "2017-09", 普通MASS: 800, 中等MIDDLE: 400, 富裕AFFLUENT: 100},
				{x0: "2017-10", 普通MASS: 900, 中等MIDDLE: 500, 富裕AFFLUENT: 200},
				{x0: "2017-11", 普通MASS: 800, 中等MIDDLE: 400, 富裕AFFLUENT: 100},
				{x0: "2017-12", 普通MASS: 900, 中等MIDDLE: 500, 富裕AFFLUENT: 200},
				{x0: "2018-01", 普通MASS: 1100, 中等MIDDLE: 700, 富裕AFFLUENT: 400},
				{x0: "2018-02", 普通MASS: 700, 中等MIDDLE: 300, 富裕AFFLUENT: 200},
				{x0: "2018-03", 普通MASS: 1000, 中等MIDDLE: 600, 富裕AFFLUENT: 300},
				{x0: "2018-04", 普通MASS: 900, 中等MIDDLE: 500, 富裕AFFLUENT: 200}
			]
	var data2=[
				 {x0: "2017-05", 普通MASS: 700, 中等MIDDLE: 400, 富裕AFFLUENT: 200},
				 {x0: "2017-06", 普通MASS: 900, 中等MIDDLE: 600, 富裕AFFLUENT: 400},
				 {x0: "2017-07", 普通MASS: 800, 中等MIDDLE: 500, 富裕AFFLUENT: 300},
				 {x0: "2017-08", 普通MASS: 900, 中等MIDDLE: 600, 富裕AFFLUENT: 400},
				 {x0: "2017-09", 普通MASS: 700, 中等MIDDLE: 400, 富裕AFFLUENT: 200},
				 {x0: "2017-10", 普通MASS: 600, 中等MIDDLE: 300, 富裕AFFLUENT: 100},
				 {x0: "2017-11", 普通MASS: 900, 中等MIDDLE: 600, 富裕AFFLUENT: 400},
				 {x0: "2017-12", 普通MASS: 1100, 中等MIDDLE: 800, 富裕AFFLUENT: 600},
				 {x0: "2018-01", 普通MASS: 600, 中等MIDDLE: 300, 富裕AFFLUENT: 100},
				 {x0: "2018-02", 普通MASS: 700, 中等MIDDLE: 400, 富裕AFFLUENT: 200},
				 {x0: "2018-03", 普通MASS: 900, 中等MIDDLE: 600, 富裕AFFLUENT: 400},
				 {x0: "2018-04", 普通MASS: 800, 中等MIDDLE: 500, 富裕AFFLUENT: 300}
			]
	var data3=[
				 {x0: "2017-05", 普通MASS: 700, 中等MIDDLE: 250, 富裕AFFLUENT: 100},
				 {x0: "2017-06", 普通MASS: 600, 中等MIDDLE: 150, 富裕AFFLUENT: 100},
				 {x0: "2017-07", 普通MASS: 700, 中等MIDDLE: 250, 富裕AFFLUENT: 100},
				 {x0: "2017-08", 普通MASS: 400, 中等MIDDLE: 50, 富裕AFFLUENT: 200},
				 {x0: "2017-09", 普通MASS: 500, 中等MIDDLE: 50, 富裕AFFLUENT: 100},
				 {x0: "2017-10", 普通MASS: 600, 中等MIDDLE: 150, 富裕AFFLUENT: 80},
				 {x0: "2017-11", 普通MASS: 500, 中等MIDDLE: 50, 富裕AFFLUENT: 90},
				 {x0: "2017-12", 普通MASS: 600, 中等MIDDLE: 150, 富裕AFFLUENT: 50},
				 {x0: "2018-01", 普通MASS: 800, 中等MIDDLE: 350, 富裕AFFLUENT: 200},
				 {x0: "2018-02", 普通MASS: 400, 中等MIDDLE: 50, 富裕AFFLUENT: 200},
				 {x0: "2018-03", 普通MASS: 700, 中等MIDDLE: 250, 富裕AFFLUENT: 100},
				 {x0: "2018-04", 普通MASS: 600, 中等MIDDLE: 150, 富裕AFFLUENT: 100}
			]
	
	var stackedbar={axisColor: null,
					axisLabelColor: null,
					axisLabelFontFamily: null,
					axisLabelFontSize: null,
					axisRotate: 45,
					axisTickColor: null,
					background: "#fff",
					baseId: "d59ccd3c096f4f609bf633647c689aa0",
					createTime: "2018-09-10 16:54:30",
					createUser: "管理员",
					fontColor: "#000",
					fontFamily: "微软雅黑",
					fontSize: 14,
					fontWeight: "noraml",
					height: 250,
					hoverfill: "red",
					hoverfillOpacity: 0.8,
					id: 12,
					legendDx: null,
					legendDy: null,
					legendFontColor: null,
					legendFontSize: null,
					legendSize: 12,
					marBottom: 10,
					marLeft: 10,
					marRight: 10,
					marTop: 10,
					padBottom: 40,
					padLeft: 40,
					padRight: 110,
					padTop: 30,
					rectPadding: 0.6,
					rectWidth: 0.6,
					rectfill: "#CF2C39,#ED8A3B,#00B7EE",
					rectfillOpacity: 0.8,
					stackedbarName: "零售信用贷款新增客户",
					stroke: " ",
					strokeOpacity: 0.8,
					titleDx: 0,
					titleDy: 0,
					updateTime: "2018-10-11 17:07:45",
					width: 800,
					x: 0,
					xOrient: "bottom",
					xTextAnchor: "middle",
					xTickpadding: 5,
					xTicks: 5,
					xTicksize: 5,
					xTitle: null,
					xTitleDx: 0,
					xTitleDy: 0,
					y: 0,
					yOrient: "left",
					yTextAnchor: "middle",
					yTickpadding: 5,
					yTicks: 5,
					yTicksize: 5,
					yTitle: null,
					yTitleDx: 2,
					yTitleDy: 0}
	var label1="#speedometer";	
	var label2="#speedometer2";
	var label3="#speedometer3";
	stackbar(data1,stackedbar,label1)	
	stackbar(data2,stackedbar,label2)
	stackbar(data3,stackedbar,label3)	
	function stackbar(data,stackedbar,label){
			
			var margin = {top: stackedbar.padTop, right: stackedbar.padRight, bottom: stackedbar.padBottom, left: stackedbar.padLeft},
				width =stackedbar.width ,
				height = stackedbar.height ;
				d3.select(label).select("svg").remove();
			var svg = d3.select(label).append("svg")
					.attr("width",width)
					.attr("height",height)
					.style("background-color",stackedbar.background)
					//.style("border","1px solid"+ stackedbar.stroke);
			width=svg.attr("width")-margin.left-margin.right;
			height=svg.attr("height")-margin.top-margin.bottom;
			
			var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		var x=d3.scaleBand()
			.rangeRound([0,width])
			.padding(stackedbar.rectWidth)
			.paddingInner(stackedbar.rectPadding)
			.align(0.5);//柱体与y轴距离
			
		var y = d3.scaleLinear()
			.rangeRound([height, 0]);
		
		var color=[];
		color=stackedbar.rectfill;
		var color_ary=color.split(",");
		console.log(color_ary);
		var z = d3.scaleOrdinal()
		.range(color_ary);
		
		//数据处理
		var data_sbar=[];
		data_sbar=data;
		
		var colum=[];
		Object.keys(data_sbar[0]).forEach(function(key,i,v){
			  colum.push(key)
		})  
		data_sbar.columns=colum;

		for( var h=0;h<data_sbar.length;h++){
			var d=data_sbar[h];
			d.total=0;
			var columns=data_sbar.columns;
			for (var i = 1, t = 0; i < columns.length; ++i)
			t += d[columns[i]] = +d[columns[i]];
			d.total = t;
		}

		
		var keys = data_sbar.columns.slice(1);
		//排序
		//data_sbar.sort(function(a, b) { return b.total - a.total; });
		
		x.domain(data_sbar.map(function(d) { return d.x0; }));
		y.domain([0, d3.max(data_sbar, function(d) { return d.total; })]).nice();
		z.domain(keys);

		g.append("g")
		.selectAll("g")
		.data(d3.stack().keys(keys)(data_sbar))
		.enter().append("g")
		  .attr("fill", function(d) { return z(d.key); })
		.selectAll("rect")
		.data(function(d) { return d; })
		.enter().append("rect")
		  .attr("x", function(d) { return x(d.data.x0); })
		  .attr("y", function(d) { return y(d[1]); })
		  .attr("height",0)
		  .attr("width", x.bandwidth())
		  .attr("fill-opacity",stackedbar.rectfillOpacity)
		  .transition().duration(500)
		  .attr("height", function(d) { return y(d[0]) - y(d[1]); });
		
		//提示框
		var tooltip=d3.select("body")
			.append("div")
			.attr("class","tooltip")
			.style("opacity",0.0);
			
		var rect=d3.selectAll("rect");
		  rect.on("mouseover",function (d,i) {
			  var tt=Object.keys(d.data);
				tooltip.html(function(){
					 var  html='';

					for(var h=0;h<+tt.length;h++){
						html+=tt[h]+':'+d.data[tt[h]]+'<br/>';
					
					}
					return html;
				})
				.style("left",(d3.event.pageX)+"px")
				.style("top",(d3.event.pageY)+"px")
				.style("opacity",1.0)
				.style("background-color","#63676c")
				.style("font-family","MicrosoftYaHei")
				.style("font-size","14px")
				.style("color","#FFF")
				.style("border-radius","5px");
			})
			.on("mousemove",function(d){
				tooltip.style("left",(d3.event.pageX)+"px")
					   .style("top",(d3.event.pageY+20)+"px");
			})
			.on("mouseout",function(d){
				tooltip.style("opacity",0.0);
				
			});

		g.append("g")
		  .attr("class", "axis axis-x")
		  .attr("transform", "translate(0," + height + ")")
		  .call(d3.axisBottom(x).ticks(stackedbar.xTicks).tickSize(stackedbar.xTicksize))
		  .append("text")
		  .attr("x",width-margin.left-margin.right)
		  .attr("y",2)
		  .attr("dy", stackedbar.xTitleDy+"em")
		  .attr("dx", stackedbar.xTitleDx+"em")
		  .attr("fill", "#000")
		  .attr("font-weight", "bold")
		  .attr("text-anchor", stackedbar.xTextAnchor)
		  .text(stackedbar.xTitle);

		g.append("g")
		  .attr("class", "axis axis-y")
		  .call(d3.axisLeft(y).ticks(stackedbar.yTicks).tickSize(stackedbar.yTicksize))
		.append("text")
		  .attr("x", 2)
		  .attr("y", y(y.ticks().pop()) + 0.5)
		  .attr("dx", stackedbar.yTitleDx+"em")
		  .attr("dy", stackedbar.yTitleDy+"em")
		  .attr("fill", "#000")
		  .attr("font-weight", "bold")
		  .attr("text-anchor", stackedbar.yTextAnchor)
		  .style("font-size",stackedbar.fontSize+"px")
		  .text(stackedbar.yTitle);
		

		var legend = g.append("g")
		  .attr("font-family", "sans-serif")
		  .attr("font-size", 10)
		  .attr("text-anchor", "end")
		.selectAll("g")
		.data(keys.slice().reverse())
		.enter().append("g")
		  .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

		legend.append("rect")
		  .attr("x", width + 80)
		  .attr("y", 50)
		  .attr("width", 19)
		  .attr("height", 19)
		  .attr("fill", z)
		  .attr("fill-opacity",stackedbar.rectfillOpacity);

		legend.append("text")
		  .attr("x", width + 75)
		  .attr("y", 10)
		  .attr("dy", "5.33em")
		  .attr("fill","#666")
		  .text(function(d) { return d; });
			
		//删除数据中total属性
		for(var h=0;h<data_sbar.length;h++){
		delete data_sbar[0].total;
		}
	}
	</script>
</body>
</html>